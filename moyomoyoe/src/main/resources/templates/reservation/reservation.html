<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>예약 시스템</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.0.2/index.global.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
        }
        main {
            margin: 20px auto;
            max-width: 800px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin-bottom: 20px;
        }
        .time-slots button {
            margin: 5px;
            padding: 10px;
            border: 1px solid #343a40;
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
        }
        .time-slots button.active {
            background-color: #343a40;
            color: white;
        }
        .hidden {
            display: none;
        }
        .disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
        }
        .fc-day.fc-past {
            opacity: 0.5;
            pointer-events: none;
        }
        .fc-day.fc-past:hover {
            cursor: not-allowed;
        }
        .fc-day.fc-sun, .holiday {
            color: red;
        }
        .fc-day.fc-future {
            color: black;
        }
    </style>
</head>
<body>
<header>
    <h1>예약 시스템</h1>
</header>
<main>
    <section id="step1">
        <h2>예약 날짜와 시간 선택</h2>
        <div class="form-group">
            <label>예약 날짜</label>
            <div id="calendar"></div>
        </div>
        <div class="form-group">
            <label>예약 시간 선택</label>
            <div class="time-slots" id="time-slots"></div>
        </div>
        <button type="button" id="next-button" class="btn btn-primary">다음 단계</button>
    </section>
    <section id="step2" class="hidden">
        <h2>예약 정보 입력</h2>
        <form id="reservation-form" method="post" action="/reservation/submit">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
            <div class="form-group">
                <label for="name">이름</label>
                <input type="text" id="name" class="form-control" name="name" placeholder="이름을 입력하세요" required>
            </div>
            <div class="form-group">
                <label for="phone">전화번호</label>
                <input type="tel" id="phone" class="form-control" name="phone" placeholder="전화번호를 입력하세요" required>
            </div>
            <div class="form-group">
                <label for="peopleCount">인원수</label>
                <select id="peopleCount" name="capacity" class="form-control" required>
                    <option value="">인원수를 선택하세요</option>
                    <option value="1">1명</option>
                    <option value="2">2명</option>
                    <option value="3">3명</option>
                    <option value="4">4명</option>
                    <option value="5">5명</option>
                    <option value="6">6명</option>
                </select>
            </div>
            <input type="hidden" id="date" name="date">
            <input type="hidden" id="startTime" name="startTime">
            <input type="hidden" id="endTime" name="endTime">
            <input type="hidden" id="storeId" name="storeId" value="1">
            <input type="hidden" id="selectedTimes" name="selectedTimes">
            <button type="submit" id="reserve-button" class="btn btn-primary">예약하기</button>
        </form>
    </section>
    <section id="step3" class="hidden">
        <h2>예약이 완료되었습니다.</h2>
        <p>예약 정보:</p>
        <p>가게명: <span id="confirm-store">업체명 1</span></p>
        <p>예약자명: <span id="confirm-name"></span></p>
        <p>예약 날짜: <span id="confirm-date"></span></p>
        <p>예약 시간: <span id="confirm-time"></span></p>
        <button type="button" id="finish-button" class="btn btn-secondary">처음으로</button>
    </section>
</main>

<script>
    let selectedDate;
    let selectedTimes = [];
    let reservedTimes = [];

    const fetchReservedTimes = (date) => {
        let storeId = $('#storeId').val();
        return $.ajax({
            url: '/reservation/getReservedTimes',
            type: 'GET',
            data: {date: date, storeId: storeId},
            success: function (data) {
                reservedTimes = data.map(time => time.slice(0, 5));
            }
        });
    };

    const renderCalendar = () => {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            initialView: 'dayGridMonth',
            selectable: true,
            validRange: {
                start: moment().format('YYYY-MM-DD')
            },
            locale: 'ko',
            dayCellContent: function(arg) {
                return { html: arg.dayNumberText.replace('일', '') };
            },
            dateClick: function (info) {
                selectedDate = info.dateStr;
                $('#date').val(selectedDate);

                fetchReservedTimes(selectedDate).then(() => {
                    const startTime = 9;
                    const endTime = 18;
                    $('#time-slots').empty();

                    for (let hour = startTime; hour <= endTime; hour++) {
                        const timeSlot = `${hour}:00`;
                        const isDisabled = reservedTimes.includes(timeSlot);

                        const timeButton = $('<button></button>')
                            .text(timeSlot)
                            .addClass('btn btn-outline-primary')
                            .toggleClass('disabled', isDisabled)
                            .prop('disabled', isDisabled)
                            .click(function () {
                                if (!$(this).hasClass('disabled')) {
                                    $(this).toggleClass('active');
                                    if ($(this).hasClass('active')) {
                                        selectedTimes.push(timeSlot);
                                    } else {
                                        selectedTimes = selectedTimes.filter(t => t !== timeSlot);
                                    }
                                    $('#selectedTimes').val(selectedTimes.join(','));
                                }
                            });
                        $('#time-slots').append(timeButton);
                    }
                });
            }
        });
        calendar.render();
    };

    $(document).ready(function () {
        renderCalendar();

        $('#reservation-form').submit(function(event) {
            event.preventDefault();

            const selectedTimes = $('#selectedTimes').val();
            if (!selectedTimes) {
                alert('예약할 시간을 선택하세요.');
                return;
            }

            const timesArray = selectedTimes.split(',');
            const startTime = timesArray[0];
            const endTime = timesArray[timesArray.length - 1];

            $('#startTime').val(startTime);
            $('#endTime').val(endTime);

            this.submit();
        });

        $('#next-button').click(function () {
            if (!selectedDate || selectedTimes.length === 0) {
                alert('예약할 시간을 선택하세요.');
                return;
            }

            $('#step1').addClass('hidden');
            $('#step2').removeClass('hidden');
        });

        $('#finish-button').click(function () {
            window.location.href = "/main.html";
        });
    });
</script>
</body>
</html>