<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="moyomoyoe.reservation.model.dao.ReservationMapper">

    <!-- Schedule 테이블에 대한 결과 매핑 -->
    <resultMap id="scheduleMap" type="moyomoyoe.reservation.model.dto.ScheduleDTO">
        <id property="scheduleId" column="schedule_id"/>
        <result property="storeId" column="store_id"/>
        <result property="storeName" column="store_name"/> <!-- 새로 추가된 필드 -->
        <result property="resDate" column="res_date"/>     <!-- 새로 추가된 필드 -->
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="capacity" column="capacity"/>
    </resultMap>

    <!-- Reservation 테이블에 대한 결과 매핑 -->
    <resultMap id="reservationMap" type="moyomoyoe.reservation.model.dto.ReservationDTO">
        <id property="resId" column="res_id"/>
        <result property="userIdRes" column="user_id_res"/>
        <result property="resDate" column="res_date"/>
        <result property="capacity" column="capacity"/>
        <result property="scheduleId" column="schedule_id"/>
    </resultMap>

    <!-- Insert into tbl_schedule (일정 테이블) -->
    <insert id="insertSchedule" parameterType="moyomoyoe.reservation.model.dto.ScheduleDTO" useGeneratedKeys="true"
            keyProperty="scheduleId">
        INSERT INTO tbl_schedule (store_id, store_name, res_date, start_time, end_time, capacity)
        VALUES (#{storeId}, #{storeName}, #{resDate,jdbcType=DATE}, #{startTime,jdbcType=TIME}, #{endTime,jdbcType=TIME}, #{capacity});
    </insert>

    <!-- Insert into tbl_reservation (예약 테이블) -->
    <insert id="insertReservation" parameterType="moyomoyoe.reservation.model.dto.ReservationDTO">
        INSERT INTO tbl_reservation (user_id_res, res_date, capacity, schedule_id)
        VALUES (#{userIdRes}, #{resDate,jdbcType=DATE}, #{capacity}, #{scheduleId});
    </insert>

    <!-- 예약된 시간 조회 -->
    <select id="getReservedTimes" resultType="string">
        SELECT CONCAT(start_time, ' - ', end_time)
        FROM tbl_schedule
        WHERE store_id = #{storeId}
          AND res_date = #{date}
    </select>

    <!-- 예약 일정 리스트 조회 -->
    <select id="getAllReservations" resultMap="reservationMap">
        SELECT r.res_id, r.user_id_res, r.res_date, r.capacity, s.schedule_id, s.start_time, s.end_time, s.store_name
        FROM tbl_reservation r
                 JOIN tbl_schedule s ON r.schedule_id = s.schedule_id
    </select>


</mapper>