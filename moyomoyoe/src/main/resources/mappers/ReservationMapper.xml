<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="moyomoyoe.reservation.model.dao.ReservationMapper">

    <!-- Schedule 테이블에 대한 결과 매핑 -->
    <resultMap id="scheduleMap" type="moyomoyoe.reservation.model.dto.ScheduleDTO">
        <id property="scheduleId" column="schedule_id"/>
        <result property="storeId" column="store_id"/>
        <result property="storeName" column="store_name"/>
        <result property="resDate" column="res_date"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="capacity" column="capacity"/>
    </resultMap>

    <!-- Reservation 테이블에 대한 결과 매핑 -->
    <resultMap id="reservationMap" type="moyomoyoe.reservation.model.dto.ReservationDTO">
        <id property="resId" column="res_id"/>
        <result property="userIdRes" column="user_id_res"/>
        <result property="resDate" column="res_date"/>
        <result property="capacity" column="capacity"/>
        <result property="scheduleId" column="schedule_id"/>
    </resultMap>

    <!-- tbl_schedule 테이블에 데이터 삽입 -->
    <insert id="insertSchedule" parameterType="moyomoyoe.reservation.model.dto.ScheduleDTO" useGeneratedKeys="true" keyProperty="scheduleId">
        INSERT INTO tbl_schedule (store_id, store_name, res_date, start_time, end_time, capacity)
        VALUES (#{storeId}, #{storeName}, #{resDate,jdbcType=DATE}, #{startTime,jdbcType=TIME}, #{endTime,jdbcType=TIME}, #{capacity});
    </insert>

    <!-- tbl_reservation 테이블에 데이터 삽입 -->
    <insert id="insertReservation" parameterType="moyomoyoe.reservation.model.dto.ReservationDTO">
        INSERT INTO tbl_reservation (user_id_res, res_date, capacity, schedule_id)
        VALUES (#{userIdRes}, #{resDate,jdbcType=DATE}, #{capacity}, #{scheduleId});
    </insert>

    <!-- 예약된 시간 조회 -->
    <select id="getReservedTimes" resultType="string">
        SELECT CONCAT(start_time, ' - ', end_time)
        FROM tbl_schedule
        WHERE store_id = #{storeId}
          AND res_date = #{date};
    </select>

    <!-- 모든 예약된 일정 가져오기 -->
    <select id="getAllReservations" resultMap="scheduleMap">
        SELECT * FROM tbl_schedule;
    </select>

    <!-- 특정 예약 목록 조회 -->
    <select id="getReservationList" resultMap="scheduleMap">
        SELECT * FROM tbl_schedule ORDER BY res_date DESC;
    </select>

    <!-- 특정 스케줄 ID로 예약 조회 -->
    <select id="getScheduleById" parameterType="int" resultMap="scheduleMap">
        SELECT * FROM tbl_schedule WHERE schedule_id = #{scheduleId};
    </select>
</mapper>